<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MochiAni - AI æ¼«å‰§åˆ¶ä½œ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Icons (Lucide Vanilla) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#1a1b1e',
                            800: '#25262b',
                            700: '#2c2e33',
                            600: '#373a40',
                        },
                        accent: '#228be6'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #1a1b1e;
            color: #c1c2c5;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1b1e; 
        }
        ::-webkit-scrollbar-thumb {
            background: #373a40; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #5c5f66; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Icon Helper ---
        // Create a React component that renders Lucide icons from the global object
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            // lucide.icons is available from the script tag
            const iconName = name; 
            const iconData = window.lucide && window.lucide.icons ? window.lucide.icons[iconName] : null;

            if (!iconData) {
                console.warn(`Icon ${name} not found`);
                return null;
            }

            // lucide icon structure in vanilla js library (latest) is often just the definition
            // We need to construct the SVG. 
            // The structure is usually: [tag, attrs, children] or similar.
            // Actually, `lucide.icons` values in recent versions are arrays of children or objects.
            // Let's rely on `lucide.createElement` logic but in React.
            // Wait, simply put: `lucide.icons[name]` gives us the abstract tree.
            
            // To be safer and simpler, let's just use the feather-icons approach or similar if lucide is too complex to parse manually without their tools.
            // BUT, let's try to map the data.
            // Standard lucide icon definition: ["svg", { ...attrs }, [ ...children ]]
            
            // To avoid complexity, I will create a few specific icon components using standard SVG strings if needed, 
            // OR I will trust that `lucide.icons` provides the path data.
            
            // ALTERNATIVE: Use a simple mapping for the icons I need.
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                    dangerouslySetInnerHTML={{ __html: iconData.map(child => {
                        const [tag, attrs] = child;
                        // Simple attributes to string
                        const attrStr = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(' ');
                        return `<${tag} ${attrStr} />`;
                    }).join('') }}
                />
            );
        };

        // Icon Shortcuts
        const Icons = {
            Plus: (props) => <Icon name="Plus" {...props} />,
            Trash2: (props) => <Icon name="Trash2" {...props} />,
            MoveUp: (props) => <Icon name="MoveUp" {...props} />,
            MoveDown: (props) => <Icon name="MoveDown" {...props} />,
            Play: (props) => <Icon name="Play" {...props} />,
            Image: (props) => <Icon name="Image" {...props} />,
            Video: (props) => <Icon name="Video" {...props} />,
            Settings: (props) => <Icon name="Settings" {...props} />,
            User: (props) => <Icon name="User" {...props} />,
            History: (props) => <Icon name="History" {...props} />,
            ChevronDown: (props) => <Icon name="ChevronDown" {...props} />,
            Search: (props) => <Icon name="Search" {...props} />,
            Film: (props) => <Icon name="Film" {...props} />,
            Mic: (props) => <Icon name="Mic" {...props} />,
            UserPlus: (props) => <Icon name="UserPlus" {...props} />,
            RefreshCw: (props) => <Icon name="RefreshCw" {...props} />,
        };

        // --- Service Layer (Backend Integration) ---
        
        const API_BASE_URL = "http://localhost:8001";
        const USE_MOCK = false; // Set to false to use real backend

        const MockData = {
            characters: [
                { id: 'c1', name: 'é™ˆè¿œ (å¤–é—¨å¼Ÿå­)', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Chen' },
                { id: 'c2', name: 'ç¥ç§˜å¸ˆå…„', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Brother' },
                { id: 'c3', name: 'é™ˆè¿œ (å‰‘ä¸»)', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=ChenMaster' },
            ],
            shots: [
                {
                    id: 1,
                    prompt: "0.1-3ç§’: ä½è§’åº¦ï¼Œå¿«é€Ÿæ¨æ‹‰é•œå¤´ã€‚é™†è¿œå—åˆ°é‡åŠ›å†²å‡»å‘åæ»‘è¡Œï¼Œèº«ä½“åœ¨é“ºæ»¡ç¢çŸ³çš„ç»ƒæ­¦åœºä¸Šåˆ’å‡ºä¸€é“å°˜åœŸé£æ‰¬çš„è½¨è¿¹ã€‚",
                    dialogue: "é™†è¿œï¼šæ»šå»é»‘æš—å‰‘å†¢é‡Œè‡ªç”Ÿè‡ªç­å§ï¼",
                    characters: ['c1'],
                    scene: null,
                    image_url: "https://placehold.co/300x169/25262b/FFF?text=Shot+1",
                },
                {
                    id: 2,
                    prompt: "é•œå¤´ä»°æ‹åˆ»å®¶å…¥å£ï¼Œå·¨çŸ³ä¸Šâ€œåˆ»å®¶â€äºŒå­—å¸ƒæ»¡å‰‘ç—•ï¼Œæ•£å‘ç€æ£®æ£®å¯’æ°”ã€‚",
                    dialogue: "(æ·±å¸ä¸€å£æ°”)",
                    characters: ['c1'],
                    scene: null,
                    image_url: "https://placehold.co/300x169/25262b/FFF?text=Shot+2",
                },
                 {
                    id: 3,
                    prompt: "é™†è¿œ(å¤–é—¨å¼Ÿå­)ç›®å…‰ä¸€å‡ï¼Œæ‰‹ä¸­é“å‰‘å‘å‡ºå—¡é¸£ã€‚(åŠ¨ä½œè™”è¯šè€Œä¸“æ³¨)ï¼Œçœ¼ç¥ä¸­å…‰å½±é£é€Ÿæµè½¬ï¼Œä»£è¡¨æ—¶é—´æµé€ã€‚",
                    dialogue: "â€œè¿™å°±æ˜¯...å‰‘æ„ï¼Ÿâ€",
                    characters: ['c1', 'c2'],
                    scene: null,
                    image_url: "https://placehold.co/300x169/25262b/FFF?text=Shot+3",
                }
            ]
        };

        const ApiService = {
            getProject: async (id) => {
                if (USE_MOCK) {
                    return new Promise(resolve => setTimeout(() => resolve({
                        id, 
                        name: "å®ˆå¢“äº”å¹´", 
                        shots: MockData.shots, 
                        characters: MockData.characters
                    }), 500));
                }
                const res = await fetch(`${API_BASE_URL}/projects/${id}`);
                return res.json();
            },

            createShot: async (projectId, shotData) => {
                if (USE_MOCK) {
                    return {
                        id: Date.now(),
                        ...shotData,
                        preview: "https://placehold.co/300x169/25262b/FFF?text=New+Shot"
                    };
                }
                const res = await fetch(`${API_BASE_URL}/projects/${projectId}/shots`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(shotData)
                });
                return res.json();
            },

            updateShot: async (projectId, shotId, updates) => {
                if (USE_MOCK) return updates; // In mock we just return what we sent
                const res = await fetch(`${API_BASE_URL}/shots/${projectId}/${shotId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updates)
                });
                return res.json();
            },

            deleteShot: async (projectId, shotId) => {
                if (USE_MOCK) return true;
                await fetch(`${API_BASE_URL}/shots/${projectId}/${shotId}`, { method: 'DELETE' });
                return true;
            },

            generate: async (shotId, type) => {
                if (USE_MOCK) {
                    return new Promise(resolve => setTimeout(() => resolve({ status: 'queued' }), 1000));
                }
                const res = await fetch(`${API_BASE_URL}/generate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ shot_id: shotId, type })
                });
                return res.json();
            },

            parseScript: async (content) => {
                if (USE_MOCK) {
                    return new Promise(resolve => setTimeout(() => {
                        const lines = content.split('\n').filter(l => l.trim());
                        resolve(lines.map(l => ({
                            prompt: l,
                            dialogue: "",
                            characters: [],
                            scene: null
                        })));
                    }, 1000));
                }
                const res = await fetch(`${API_BASE_URL}/api/parse-script`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ content })
                });
                return res.json();
            }
        };

        // --- Components ---

        const AddScriptModal = ({ isOpen, onClose, onSubmit }) => {
            const [content, setContent] = React.useState("");
            const [isParsing, setIsParsing] = React.useState(false);

            if (!isOpen) return null;

            const handleSubmit = async () => {
                if (!content.trim()) return;
                setIsParsing(true);
                await onSubmit(content);
                setIsParsing(false);
                setContent("");
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                    <div className="bg-dark-800 w-[600px] rounded-lg border border-dark-700 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="p-4 border-b border-dark-700 flex justify-between items-center bg-dark-900">
                            <h3 className="font-bold text-gray-200 flex items-center gap-2">
                                <Icons.Film size={18} className="text-accent"/> 
                                æ·»åŠ å‰§æœ¬ (AI è‡ªåŠ¨è§£æ)
                            </h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-white"><Icons.Plus size={20} className="rotate-45"/></button>
                        </div>
                        <div className="p-4 flex-1 flex flex-col gap-4">
                            <div className="bg-blue-500/10 border border-blue-500/20 rounded p-3 text-xs text-blue-200">
                                ğŸ’¡ ç²˜è´´å°è¯´ã€å‰§æœ¬ç‰‡æ®µï¼ŒAI å°†è‡ªåŠ¨æ‹†åˆ†ä¸ºåˆ†é•œé•œå¤´ã€‚å»ºè®®åŒ…å«åœºæ™¯æè¿°ã€åŠ¨ä½œå’Œå°è¯ã€‚
                            </div>
                            <textarea 
                                className="flex-1 w-full bg-dark-900 border border-dark-700 rounded p-3 text-sm text-gray-300 focus:border-accent focus:outline-none resize-none min-h-[300px]"
                                placeholder="ä¾‹å¦‚ï¼š
åœºæ™¯ï¼šå¹½æš—çš„æ£®æ—
1. é™†è¿œæ°”å–˜åååœ°å¥”è·‘ï¼Œå›å¤´å¼ æœ›ã€‚ï¼ˆç‰¹å†™ï¼‰
2. å‰æ–¹å‡ºç°ä¸€é“æ‚¬å´–ã€‚ï¼ˆè¿œæ™¯ï¼‰
..."
                                value={content}
                                onChange={e => setContent(e.target.value)}
                            />
                        </div>
                        <div className="p-4 border-t border-dark-700 bg-dark-900 flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 rounded text-sm text-gray-400 hover:text-white hover:bg-dark-700">å–æ¶ˆ</button>
                            <button 
                                onClick={handleSubmit} 
                                disabled={isParsing || !content.trim()}
                                className="px-6 py-2 rounded text-sm bg-accent text-white font-medium hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                {isParsing ? 'æ­£åœ¨è§£æ...' : 'å¼€å§‹æ™ºèƒ½æ‹†è§£'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 1. Header
        const Header = () => (
            <header className="h-14 border-b border-dark-700 flex items-center justify-between px-4 bg-dark-800 flex-shrink-0">
                <div className="flex items-center gap-4">
                    <h1 className="text-lg font-bold text-white flex items-center gap-2">
                        <span className="text-accent">MochiAni</span>
                        <span className="text-sm font-normal text-gray-400">| å®ˆå¢“äº”å¹´ï¼Œæˆ‘æºä¸‡å‰‘å½’...</span>
                    </h1>
                    <div className="flex gap-2">
                        <button className="px-3 py-1 text-xs bg-dark-700 text-gray-300 rounded hover:bg-dark-600 flex items-center gap-1">
                            é£æ ¼: æ—¥æ¼« <Icons.ChevronDown size={12}/>
                        </button>
                        <button className="px-3 py-1 text-xs bg-dark-700 text-gray-300 rounded hover:bg-dark-600 flex items-center gap-1">
                            æ—¶ä»£: æœªè®¾ç½® <Icons.ChevronDown size={12}/>
                        </button>
                         <button className="px-3 py-1 text-xs bg-dark-700 text-gray-300 rounded hover:bg-dark-600 flex items-center gap-1">
                            æ¨¡å‹é…ç½® <Icons.ChevronDown size={12}/>
                        </button>
                    </div>
                </div>
                <div className="flex items-center gap-3 text-gray-400">
                    <button className="hover:text-white flex items-center gap-1 text-sm"><Icons.History size={16}/> ç”Ÿæˆè®°å½•</button>
                    <button className="hover:text-white"><Icons.Settings size={18}/></button>
                    <button className="hover:text-white"><Icons.User size={18}/></button>
                </div>
            </header>
        );

        // 2. Sidebar (Asset Manager)
        const Sidebar = ({ characters }) => {
            const [activeTab, setActiveTab] = React.useState('chars');

            return (
                <aside className="w-80 border-l border-dark-700 bg-dark-800 flex flex-col flex-shrink-0">
                    <div className="flex border-b border-dark-700">
                        <button 
                            className={`flex-1 py-3 text-sm font-medium ${activeTab === 'chars' ? 'text-accent border-b-2 border-accent' : 'text-gray-400'}`}
                            onClick={() => setActiveTab('chars')}
                        >è§’è‰²</button>
                        <button 
                            className={`flex-1 py-3 text-sm font-medium ${activeTab === 'scenes' ? 'text-accent border-b-2 border-accent' : 'text-gray-400'}`}
                            onClick={() => setActiveTab('scenes')}
                        >åœºæ™¯</button>
                        <button 
                            className={`flex-1 py-3 text-sm font-medium ${activeTab === 'props' ? 'text-accent border-b-2 border-accent' : 'text-gray-400'}`}
                            onClick={() => setActiveTab('props')}
                        >é“å…·</button>
                    </div>
                    
                    <div className="p-4 flex-1 overflow-y-auto custom-scrollbar">
                        <button className="w-full bg-accent hover:bg-blue-600 text-white py-2 rounded mb-4 text-sm font-medium flex items-center justify-center gap-2">
                            <Icons.Film size={16}/> æ‰¹é‡ç”Ÿæˆ
                        </button>

                        {activeTab === 'chars' && (
                            <div className="space-y-6">
                                <div>
                                    <h3 className="text-xs font-bold text-gray-500 mb-3 uppercase flex items-center justify-between">
                                        ä½œå“ä¸­è§’è‰² (3)
                                        <span className="text-[10px] bg-dark-700 px-1 rounded">Active</span>
                                    </h3>
                                    <div className="grid grid-cols-3 gap-2">
                                        {characters.map(char => (
                                            <div key={char.id} className="flex flex-col items-center gap-1 group cursor-pointer">
                                                <div className="w-16 h-16 rounded overflow-hidden bg-dark-600 border border-transparent group-hover:border-accent relative">
                                                    <img src={char.avatar} alt={char.name} className="w-full h-full object-cover"/>
                                                    <div className="absolute top-0 right-0 p-0.5 bg-black/50 rounded-bl hidden group-hover:block">
                                                        <Icons.Trash2 size={10} className="text-red-400"/>
                                                    </div>
                                                </div>
                                                <span className="text-[10px] text-gray-400 truncate w-full text-center">{char.name}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="text-xs font-bold text-gray-500 uppercase">å…¨éƒ¨å¯é€‰è§’è‰²</h3>
                                        <div className="relative">
                                            <input type="text" placeholder="æœç´¢..." className="bg-dark-900 text-xs px-2 py-1 pl-6 rounded w-24 border border-dark-700 focus:border-accent outline-none"/>
                                            <Icons.Search size={10} className="absolute left-1.5 top-1.5 text-gray-500"/>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        {/* Mock Library */}
                                        {[1,2,3,4,5,6].map(i => (
                                             <div key={i} className="flex flex-col items-center gap-1 group cursor-pointer opacity-60 hover:opacity-100 transition-opacity">
                                                <div className="w-16 h-16 rounded bg-dark-700 flex items-center justify-center border border-transparent group-hover:border-gray-500">
                                                    <Icons.User size={24} className="text-dark-500"/>
                                                </div>
                                                <span className="text-[10px] text-gray-400">è§’è‰² {i}</span>
                                            </div>
                                        ))}
                                        <div className="flex flex-col items-center gap-1 cursor-pointer hover:text-accent group">
                                            <div className="w-16 h-16 rounded border border-dashed border-dark-600 flex items-center justify-center group-hover:border-accent group-hover:bg-dark-700">
                                                <Icons.Plus size={24}/>
                                            </div>
                                            <span className="text-[10px] text-gray-400 group-hover:text-accent">æ–°å»º</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'scenes' && (
                             <div className="text-center py-10 text-gray-500 text-xs">
                                æš‚æ— åœºæ™¯èµ„äº§ï¼Œè¯·å…ˆä¸Šä¼ æˆ–ç”Ÿæˆ
                             </div>
                        )}
                    </div>
                </aside>
            );
        };

        // 2.5 Shot List Header
        const ShotListHeader = () => (
            <div className="grid grid-cols-[40px_minmax(300px,2fr)_1fr_1fr_1.5fr_40px] gap-4 px-4 py-2 bg-dark-800 border-b border-dark-700 text-xs font-bold text-gray-500 uppercase tracking-wider sticky top-0 z-10 shadow-sm">
                <div className="text-center">åºå·</div>
                <div>å‰§æœ¬</div>
                <div>å‡ºåœºäººç‰©</div>
                <div>ç”»é¢</div>
                <div>è§†é¢‘</div>
                <div className="text-center">æ“ä½œ</div>
            </div>
        );

        // 3. Shot List Item
        const ShotItem = ({ shot, index, onDelete, onUpdate, onGenerate }) => {
            return (
                <div className="grid grid-cols-[40px_minmax(300px,2fr)_1fr_1fr_1.5fr_40px] gap-4 p-4 border-b border-dark-700 bg-dark-800/30 hover:bg-dark-800 transition-colors group items-start">
                    {/* Column 1: Index */}
                    <div className="flex flex-col items-center gap-2 pt-1">
                        <span className="text-xs font-mono text-gray-500 bg-dark-900 px-1.5 py-0.5 rounded-full min-w-[24px] text-center">{index + 1}</span>
                        <input type="checkbox" className="rounded bg-dark-700 border-dark-600 w-4 h-4 cursor-pointer accent-accent"/>
                    </div>

                    {/* Column 2: Script */}
                    <div className="space-y-3">
                         <div className="relative">
                             <div className="flex justify-between items-center mb-1">
                                <label className="text-[10px] text-gray-500 uppercase tracking-wider font-bold">è§†è§‰æè¿° (Prompt)</label>
                                <span className="text-[10px] text-dark-600 cursor-pointer hover:text-accent">AI ä¼˜åŒ–</span>
                             </div>
                            <textarea 
                                className="w-full bg-dark-900/50 border border-dark-700 rounded p-2 text-sm text-gray-300 focus:border-accent focus:outline-none resize-none h-20 placeholder-gray-700 transition-colors"
                                value={shot.prompt}
                                placeholder="æè¿°ç”»é¢å†…å®¹ã€é•œå¤´è§’åº¦ã€å…‰å½±..."
                                onChange={(e) => onUpdate(shot.id, { ...shot, prompt: e.target.value })}
                            />
                        </div>
                    </div>

                    {/* Column 3: Characters */}
                    <div className="space-y-2">
                         <div className="flex justify-between items-center">
                            <label className="text-[10px] text-gray-500 uppercase tracking-wider font-bold">å‡ºåœºäººç‰©</label>
                            <Icons.Plus size={12} className="cursor-pointer hover:text-white text-gray-500"/>
                         </div>
                         <div className="grid grid-cols-3 gap-2">
                            {shot.characters.map((charId, i) => (
                                <div key={i} className="aspect-square rounded bg-dark-700 border border-dark-600 overflow-hidden relative group/char">
                                    <img src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${charId}`} className="w-full h-full object-cover"/>
                                    <div className="absolute inset-0 bg-black/60 hidden group-hover/char:flex items-center justify-center cursor-pointer">
                                        <Icons.Trash2 size={10} className="text-red-400"/>
                                    </div>
                                </div>
                            ))}
                            <button className="aspect-square rounded border border-dashed border-dark-600 flex items-center justify-center hover:bg-dark-700 text-dark-500 hover:text-accent hover:border-accent transition-colors">
                                <Icons.Plus size={14}/>
                            </button>
                         </div>
                    </div>

                    {/* Column 4: Image/Scene */}
                    <div className="space-y-2">
                         <div className="flex justify-between items-center">
                            <label className="text-[10px] text-gray-500 uppercase tracking-wider font-bold">ç”»é¢</label>
                         </div>
                         <div className="aspect-video w-full rounded border border-dark-700 overflow-hidden bg-dark-900/30 relative group/image">
                            {shot.image_url ? (
                                <>
                                    <img src={shot.image_url} className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/50 hidden group-hover/image:flex items-center justify-center gap-2">
                                         <button onClick={() => onGenerate(shot.id, 'image')} className="text-xs bg-accent px-2 py-1 rounded text-white flex items-center gap-1">
                                            <Icons.RefreshCw size={12}/> é‡ç»˜
                                         </button>
                                    </div>
                                </>
                            ) : (
                                <button 
                                    onClick={() => onGenerate(shot.id, 'image')}
                                    className="w-full h-full flex flex-col items-center justify-center gap-1 text-dark-500 hover:text-accent hover:bg-dark-800 transition-colors"
                                >
                                    <Icons.Image size={20}/>
                                    <span className="text-[10px]">ç”Ÿæˆå›¾ç‰‡</span>
                                </button>
                            )}
                         </div>
                    </div>

                    {/* Column 5: Video */}
                    <div className="space-y-2">
                         <div className="flex justify-between items-center">
                            <label className="text-[10px] text-gray-500 uppercase tracking-wider font-bold">è§†é¢‘</label>
                         </div>
                         <div className="aspect-video w-full rounded border border-dark-700 overflow-hidden bg-dark-900/30 relative group/video">
                            {shot.video_url ? (
                                <>
                                    <video src={shot.video_url} className="w-full h-full object-cover" controls />
                                     <div className="absolute inset-0 bg-black/50 hidden group-hover/video:flex items-center justify-center gap-2 pointer-events-none">
                                         <button onClick={() => onGenerate(shot.id, 'video')} className="text-xs bg-accent px-2 py-1 rounded text-white flex items-center gap-1 pointer-events-auto">
                                            <Icons.RefreshCw size={12}/> é‡ç»˜
                                         </button>
                                    </div>
                                </>
                            ) : (
                                 <button 
                                    onClick={() => onGenerate(shot.id, 'video')}
                                    className="w-full h-full flex flex-col items-center justify-center gap-1 text-dark-500 hover:text-accent hover:bg-dark-800 transition-colors"
                                    title={!shot.image_url ? "è¯·å…ˆç”Ÿæˆå›¾ç‰‡" : ""}
                                >
                                    <Icons.Video size={20}/>
                                    <span className="text-[10px]">ç”Ÿæˆè§†é¢‘</span>
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Column 6: Actions */}
                    <div className="flex flex-col gap-2 pt-1 items-center">
                        <button className="hover:text-white hover:bg-dark-700 p-1 rounded text-gray-500" title="ä¸Šç§»"><Icons.MoveUp size={14}/></button>
                        <button className="hover:text-white hover:bg-dark-700 p-1 rounded text-gray-500" title="ä¸‹ç§»"><Icons.MoveDown size={14}/></button>
                        <button className="hover:text-red-400 hover:bg-dark-700 p-1 rounded mt-2 text-gray-500" onClick={() => onDelete(shot.id)} title="åˆ é™¤"><Icons.Trash2 size={14}/></button>
                    </div>
                </div>
            );
        };

        // 4. Main App
        const App = () => {
            const [shots, setShots] = React.useState([]);
            const [characters, setCharacters] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [showScriptModal, setShowScriptModal] = React.useState(false);
            const projectId = "default_project";

            // Load initial data
            React.useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    try {
                        const project = await ApiService.getProject(projectId);
                        setShots(project.shots);
                        setCharacters(project.characters);
                    } catch (error) {
                        console.error("Failed to load project", error);
                    }
                    setLoading(false);
                };
                loadData();
            }, []);

            const handleDelete = async (id) => {
                if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé•œå¤´å—ï¼Ÿ')) {
                    // Optimistic update
                    const originalShots = [...shots];
                    setShots(shots.filter(s => s.id !== id));
                    try {
                        await ApiService.deleteShot(projectId, id);
                    } catch (e) {
                        alert('åˆ é™¤å¤±è´¥');
                        setShots(originalShots);
                    }
                }
            };

            const handleUpdate = async (id, newShot) => {
                // Optimistic update
                setShots(shots.map(s => s.id === id ? newShot : s));
                // Debounce could be added here
                await ApiService.updateShot(projectId, id, newShot);
            };

            const handleAddShot = async () => {
                const tempId = Date.now();
                const newShotData = {
                    prompt: "",
                    dialogue: "",
                    characters: [],
                    scene: null,
                };
                
                // Optimistic UI
                const optimisitcShot = {
                     id: tempId, 
                     ...newShotData, 
                     image_url: "https://placehold.co/300x169/25262b/FFF?text=Loading..." 
                };
                setShots([...shots, optimisitcShot]);

                try {
                    const createdShot = await ApiService.createShot(projectId, newShotData);
                    // Replace temp ID with real one
                    setShots(prev => prev.map(s => s.id === tempId ? createdShot : s));
                } catch (e) {
                    console.error("Create failed", e);
                }
            };

            const handleGenerate = async (shotId, type) => {
                 // Trigger generation
                 alert(`æ­£åœ¨è¯·æ±‚åç«¯ç”Ÿæˆ ${type}... (Mock Mode)`);
                 await ApiService.generate(shotId, type);
            };

            const handleParseScript = async (content) => {
                try {
                    const parsedShots = await ApiService.parseScript(content);
                    // Create shots sequentially
                    const newShots = [];
                    for (const shotData of parsedShots) {
                         const createdShot = await ApiService.createShot(projectId, shotData);
                         newShots.push(createdShot);
                    }
                    setShots(prev => [...prev, ...newShots]);
                } catch (e) {
                    console.error("Parse failed", e);
                    alert("è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡");
                }
            };

            if (loading) {
                return <div className="h-screen flex items-center justify-center bg-dark-900 text-gray-500">åŠ è½½é¡¹ç›®ä¸­...</div>;
            }

            return (
                <div className="flex flex-col h-screen overflow-hidden font-sans">
                    <Header />
                    <div className="flex flex-1 overflow-hidden">
                        <main className="flex-1 flex flex-col min-w-0 bg-dark-900">
                            {/* Toolbar */}
                            <div className="h-10 border-b border-dark-700 flex items-center px-4 gap-4 bg-dark-800 text-xs text-gray-400 flex-shrink-0">
                                <span className="font-medium text-gray-300">å…± {shots.length} ä¸ªé•œå¤´</span>
                                <div className="h-4 w-px bg-dark-600"></div>
                                <button onClick={handleAddShot} className="hover:text-white flex items-center gap-1 transition-colors">
                                    <Icons.Plus size={12}/> æ·»åŠ ç©ºç™½é•œå¤´
                                </button>
                                <button onClick={() => setShowScriptModal(true)} className="hover:text-white flex items-center gap-1 transition-colors text-accent">
                                    <Icons.Film size={12}/> æ·»åŠ å‰§æœ¬
                                </button>
                                <div className="h-4 w-px bg-dark-600"></div>
                                <button className="hover:text-white flex items-center gap-1 transition-colors ml-auto text-accent">
                                    <Icons.Film size={12}/> å¯¼å‡ºè§†é¢‘
                                </button>
                            </div>

                            {/* Shot List Header & Content */}
                            <div className="flex-1 flex flex-col overflow-hidden">
                                <ShotListHeader />
                                <div className="flex-1 overflow-y-auto pb-20 custom-scrollbar">
                                    {shots.map((shot, index) => (
                                        <ShotItem 
                                            key={shot.id} 
                                            shot={shot} 
                                            index={index}
                                            onDelete={handleDelete}
                                            onUpdate={handleUpdate}
                                            onGenerate={handleGenerate}
                                        />
                                    ))}
                                    <div className="p-4">
                                        <button 
                                            onClick={handleAddShot}
                                            className="w-full py-4 border-2 border-dashed border-dark-700 rounded-lg text-gray-500 hover:border-accent hover:text-accent flex items-center justify-center gap-2 transition-all hover:bg-dark-800"
                                        >
                                            <Icons.Plus size={20}/> æ·»åŠ æ–°é•œå¤´
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </main>
                        <Sidebar characters={characters}/>
                    </div>
                    <AddScriptModal 
                        isOpen={showScriptModal} 
                        onClose={() => setShowScriptModal(false)} 
                        onSubmit={handleParseScript}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
